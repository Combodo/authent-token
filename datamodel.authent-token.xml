<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.2">
  <constants>
  </constants>
  <classes>
    <class id="Oauth2Application" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <category>addon/authentication,grant_by_profile</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_oauth2_server_application</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <icon/>
        <naming>
          <attributes>
            <attribute id="application"/>
          </attributes>
        </naming>
        <reconciliation>
          <attributes>
            <attribute id="application"/>
            <attribute id="org_id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <field id="org_id" xsi:type="AttributeExternalKey">
          <sql>org_id</sql>
          <dependencies/>
          <is_null_allowed>false</is_null_allowed>
          <allow_target_creation>false</allow_target_creation>
          <display_style>list</display_style>
          <target_class>Organization</target_class>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="application" xsi:type="AttributeString">
          <sql>application</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="realm" xsi:type="AttributeString">
          <sql>realm</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="scope" xsi:type="AttributeString">
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <sql>scope</sql>
        </field>
        <field id="client_id" xsi:type="AttributeString">
          <sql>client_id</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="redirect_url" xsi:type="AttributeURL">
          <sql>redirect_url</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="code" xsi:type="AttributeString">
          <sql>code</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="client_secret" xsi:type="AttributeEncryptedPassword">
          <sql>client_secret</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="users_list" xsi:type="AttributeLinkedSetIndirect">
          <ext_key_to_me>application_id</ext_key_to_me>
          <ext_key_to_remote>user_id</ext_key_to_remote>
          <linked_class>lnkOauth2ApplicationToUser</linked_class>
          <count_min>0</count_min>
          <count_max>0</count_max>
        </field>
      </fields>
      <event_listeners>
        <event_listener id="EVENT_DB_BEFORE_WRITE">
          <event>EVENT_DB_BEFORE_WRITE</event>
          <callback>EvtBeforeWriteOauth2Application</callback>
          <rank>0</rank>
        </event_listener>
        <event_listener id="EVENT_DB_AFTER_WRITE">
          <event>EVENT_DB_AFTER_WRITE</event>
          <callback>EvtAfterWriteOauth2Application</callback>
          <rank>0</rank>
        </event_listener>
        <event_listener id="EVENT_DB_SET_ATTRIBUTES_FLAGS">
          <event>EVENT_DB_SET_ATTRIBUTES_FLAGS</event>
          <callback>EvtSetAttributeFlagsOauth2Application</callback>
          <rank>0</rank>
        </event_listener>
        <event_listener id="EVENT_DB_SET_INITIAL_ATTRIBUTES_FLAGS">
          <event>EVENT_DB_SET_INITIAL_ATTRIBUTES_FLAGS</event>
          <callback>EvtSetInitialAttributeFlagsOauth2Application</callback>
          <rank>0</rank>
        </event_listener>
      </event_listeners>
      <methods>
        <method id="EvtBeforeWriteOauth2Application">
        <comment>/**
          * Event Listener for EVENT_DB_BEFORE_WRITE
          * An object is about to be written into the database.
          * The object can be modified.
          *
          * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
          */
        </comment>
        <static>false</static>
        <access>public</access>
        <type>EventListener</type>
        <code><![CDATA[	public function EvtBeforeWriteOauth2Application(Combodo\iTop\Service\Events\EventData $oEventData)
          {
            if ($oEventData->Get('is_new')) {
		          $this->Set('client_secret', Combodo\iTop\AuthentToken\Service\Oauth2ApplicationService::GetInstance()->GenerateClientSecret());
		          $this->Set('client_id', Combodo\iTop\AuthentToken\Service\Oauth2ApplicationService::GetInstance()->GenerateClientId());
            }
          }]]></code>
      </method>
        <method id="EvtAfterWriteOauth2Application">
          <comment>/**
            * Event Listener for EVENT_DB_BEFORE_WRITE
            * An object is about to be written into the database.
            * The object can be modified.
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[	public function EvtAfterWriteOauth2Application(Combodo\iTop\Service\Events\EventData $oEventData)
          {
            if ($oEventData->Get('is_new')) {
              $sSecret = $this->Get('client_secret')->GetPassword();
              $sMessage = \Dict::Format('AuthentToken:ClientSecret', $sSecret);
              self::SetSessionMessage(get_class($this), $this->GetKey(), 1, $sMessage, WebPage::ENUM_SESSION_MESSAGE_SEVERITY_OK, 1);
            }
          }]]></code>
        </method>
        <method id="EvtSetAttributeFlagsOauth2Application">
          <comment>/**
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[
	        public function EvtSetAttributeFlagsOauth2Application(Combodo\iTop\Service\Events\EventData $oEventData)
          {
                $this->AddAttributeFlags('client_secret', OPT_ATT_READONLY);
                $this->AddAttributeFlags('client_id', OPT_ATT_READONLY);
          }]]></code>
        </method>
        <method id="EvtSetInitialAttributeFlagsOauth2Application">
          <comment>/**
            *
            * @param Combodo\iTop\Service\Events\EventData $oEventData Event data object
            */
          </comment>
          <static>false</static>
          <access>public</access>
          <type>EventListener</type>
          <code><![CDATA[
	        public function EvtSetInitialAttributeFlagsOauth2Application(Combodo\iTop\Service\Events\EventData $oEventData)
          {
                $this->AddInitialAttributeFlags('code', OPT_ATT_READONLY);
                $this->AddInitialAttributeFlags('client_secret', OPT_ATT_READONLY);
                $this->AddInitialAttributeFlags('client_id', OPT_ATT_READONLY);
          }]]></code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="application">
              <rank>10</rank>
            </item>
            <item id="org_id">
              <rank>20</rank>
            </item>
            <item id="scope">
              <rank>30</rank>
            </item>
            <item id="realm">
              <rank>40</rank>
            </item>
            <item id="redirect_url">
              <rank>50</rank>
            </item>
            <item id="code">
              <rank>60</rank>
            </item>
            <item id="client_id">
              <rank>70</rank>
            </item>
            <item id="client_secret">
              <rank>80</rank>
            </item>
            <item id="users_list">
              <rank>90</rank>
            </item>
          </items>
        </details>
        <list>
          <items>
            <item id="application">
              <rank>10</rank>
            </item>
            <item id="org_id">
              <rank>20</rank>
            </item>
            <item id="scope">
              <rank>30</rank>
            </item>
            <item id="realm">
              <rank>35</rank>
            </item>
          </items>
        </list>
        <search>
          <items>
            <item id="application">
              <rank>10</rank>
            </item>
            <item id="org_id">
              <rank>20</rank>
            </item>
            <item id="scope">
              <rank>30</rank>
            </item>
            <item id="realm">
              <rank>35</rank>
            </item>
            <item id="client_id">
              <rank>40</rank>
            </item>
          </items>
        </search>
      </presentation>
    </class>
    <class id="lnkOauth2ApplicationToUser" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <category>addon/authentication,grant_by_profile</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_lnk_oauth2_server_application_to_user</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <icon/>
        <naming>
          <attributes>
            <attribute id="application_id"/>
            <attribute id="user_id"/>
          </attributes>
        </naming>
        <reconciliation>
          <attributes>
            <attribute id="application_id"/>
            <attribute id="user_id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <field id="application_id" xsi:type="AttributeExternalKey">
          <sql>application_id</sql>
          <dependencies/>
          <is_null_allowed>false</is_null_allowed>
          <allow_target_creation>false</allow_target_creation>
          <display_style>list</display_style>
          <target_class>Oauth2Application</target_class>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="user_id" xsi:type="AttributeExternalKey">
          <sql>user_id</sql>
          <dependencies/>
          <is_null_allowed>false</is_null_allowed>
          <allow_target_creation>false</allow_target_creation>
          <display_style>list</display_style>
          <target_class>User</target_class>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="refresh_token" xsi:type="AttributeEncryptedPassword">
          <sql>refresh_token</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="refresh_token_expiration" xsi:type="AttributeDateTime">
          <sql>refresh_token_expiration</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="access_token" xsi:type="AttributeEncryptedPassword">
          <sql>access_token</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="access_token_expiration" xsi:type="AttributeDateTime">
          <sql>access_token_expiration</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="authorization_state" xsi:type="AttributeString">
          <sql>authorization_state</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <field id="token_type" xsi:type="AttributeString">
          <sql>token_type</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
      </fields>
      <methods/>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="application_id">
                  <rank>10</rank>
                </item>
                <item id="user_id">
                  <rank>20</rank>
                </item>
                <item id="status">
                  <rank>30</rank>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>10</rank>
              <items>
                <item id="access_token">
                  <rank>70</rank>
                </item>
                <item id="access_token_expiration">
                  <rank>80</rank>
                </item>
                <item id="refresh_token">
                  <rank>90</rank>
                </item>
                <item id="refresh_token_expiration">
                  <rank>100</rank>
                </item>
                <item id="token_type">
                  <rank>110</rank>
                </item>
                <item id="authorization_state">
                  <rank>120</rank>
                </item>
              </items>
            </item>
          </items>
        </details>
        <list>
          <items>
            <item id="application_id">
              <rank>10</rank>
            </item>
            <item id="user_id">
              <rank>20</rank>
            </item>
          </items>
        </list>
        <search>
          <items>
            <item id="application_id">
              <rank>10</rank>
            </item>
            <item id="user_id">
              <rank>20</rank>
            </item>
          </items>
        </search>
      </presentation>
    </class>
    <class id="PersonalToken" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <php_parent>
        <name>AbstractPersonalToken</name>
      </php_parent>
      <properties>
        <category>addon/authentication,grant_by_profile</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_personal_token</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <icon/>
        <naming>
          <attributes>
            <attribute id="application"/>
          </attributes>
        </naming>
        <reconciliation>
          <attributes>
            <attribute id="application"/>
            <attribute id="user_id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <field id="user_id" xsi:type="AttributeExternalKey">
          <sql>user_id</sql>
          <dependencies/>
          <is_null_allowed>false</is_null_allowed>
          <allow_target_creation>false</allow_target_creation>
          <display_style>list</display_style>
          <target_class>User</target_class>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="org_id" xsi:type="AttributeExternalField">
          <extkey_attcode>user_id</extkey_attcode>
          <target_attcode>org_id</target_attcode>
        </field>
        <field id="auth_token" xsi:type="AttributeOneWayPassword">
          <sql>auth_token</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <field id="application" xsi:type="AttributeString">
          <sql>application</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- Duplicated field in UserToken class -->
        <field id="scope" xsi:type="AttributeEnumSet">
          <values>
            <value id="WebService">
              <code>REST/JSON</code>
            </value>
            <value id="Synchro">
              <code>Synchro</code>
            </value>
            <value id="Import">
              <code>Import</code>
            </value>
            <value id="Export">
              <code>Export</code>
            </value>
          </values>
          <sql>scope</sql>
          <default_value>WebService</default_value>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="expiration_date" xsi:type="AttributeDateTime" _delta="define">
          <sql>expiration_date</sql>
          <default_value/>
          <tracking_level>none</tracking_level>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="use_count" xsi:type="AttributeInteger" _delta="define">
          <sql>use_count</sql>
          <default_value>0</default_value>
          <tracking_level>none</tracking_level>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <field id="last_use_date" xsi:type="AttributeDateTime" _delta="define">
          <sql>last_use_date</sql>
          <default_value/>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods>
        <method id="GetAttributeFlags">
          <comment></comment>
          <static>false</static>
          <access>public </access>
          <code><![CDATA[   	public function GetAttributeFlags($sAttCode, &$aReasons = array(), $sTargetState = '')
	{
		// This function is invoked when the object is EDITED on the Console
		// It is called for each and every field of the object,
		// but we just want to change the behavior for a single field
		if ($sAttCode == 'use_count' || $sAttCode == 'last_use_date')
		{
			// Combine the new Flag with those impose by a parent class
			return(OPT_ATT_READONLY | parent::GetAttributeFlags($sAttCode, $aReasons, $sTargetState));
		}
		return parent::GetAttributeFlags($sAttCode, $aReasons, $sTargetState);
	}]]></code>
        </method>
        <method id="GetInitialStateAttributeFlags">
          <comment></comment>
          <static>false</static>
          <access>public </access>
          <code><![CDATA[   	public function GetInitialStateAttributeFlags($sAttCode, &$aReasons = array())
{
    // This function is invoked when the object is CREATED on the Console
    // It is called for each and every field of the object,
    // but we just want to change the behavior for a single field
		if ($sAttCode == 'use_count' || $sAttCode == 'last_use_date')
    {
        // Combine the new Flag with those imposed by a parent class
        return(OPT_ATT_READONLY | parent::GetInitialStateAttributeFlags($sAttCode, $aReasons));
    }
    // For other fields ask the parent class to do the job
    return parent::GetInitialStateAttributeFlags($sAttCode, $aReasons);
}]]></code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="user_id">
              <rank>10</rank>
            </item>
            <item id="org_id">
              <rank>20</rank>
            </item>
            <item id="application">
              <rank>30</rank>
            </item>
            <item id="scope">
              <rank>40</rank>
            </item>
            <item id="expiration_date">
              <rank>50</rank>
            </item>
            <item id="use_count">
              <rank>60</rank>
            </item>
            <item id="last_use_date">
              <rank>70</rank>
            </item>
          </items>
        </details>
        <list>
          <items>
            <item id="user_id">
              <rank>10</rank>
            </item>
            <item id="application">
              <rank>20</rank>
            </item>
            <item id="scope">
              <rank>30</rank>
            </item>
            <item id="expiration_date">
              <rank>40</rank>
            </item>
          </items>
        </list>
        <search>
          <items>
            <item id="user_id">
              <rank>10</rank>
            </item>
            <item id="application">
              <rank>20</rank>
            </item>
            <item id="scope">
              <rank>30</rank>
            </item>
            <item id="expiration_date">
              <rank>40</rank>
            </item>
          </items>
        </search>
        <default_search>
          <items>
            <item id="application">
              <rank>10</rank>
            </item>
            <item id="user_id">
              <rank>20</rank>
            </item>
            <item id="org_id">
              <rank>30</rank>
            </item>
            <item id="expiration_date">
              <rank>40</rank>
            </item>
          </items>
        </default_search>
      </presentation>
    </class>
    <class id="UserToken" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <php_parent>
        <name>AbstractApplicationToken</name>
      </php_parent>
      <properties>
        <category>addon/authentication,grant_by_profile</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>priv_user_token</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <icon/>
        <naming>
          <attributes>
            <attribute id="login"/>
          </attributes>
        </naming>
      </properties>
      <fields>
        <field id="auth_token" xsi:type="AttributeOneWayPassword">
          <sql>auth_token</sql>
          <default_value/>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- Duplicated field in PersonalToken class -->
        <field id="scope" xsi:type="AttributeEnumSet">
          <values>
            <value id="WebService">
              <code>REST/JSON</code>
            </value>
            <value id="Synchro">
              <code>Synchro</code>
            </value>
            <value id="Import">
              <code>Import</code>
            </value>
            <value id="Export">
              <code>Export</code>
            </value>
          </values>
          <sql>scope</sql>
          <default_value>WebService</default_value>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods/>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="fieldset:User:info">
                  <rank>10</rank>
                  <items>
                    <item id="contactid">
                      <rank>10</rank>
                    </item>
                    <item id="org_id">
                      <rank>20</rank>
                    </item>
                    <item id="email">
                      <rank>30</rank>
                    </item>
                    <item id="login">
                      <rank>40</rank>
                    </item>
                    <item id="scope">
                      <rank>45</rank>
                    </item>
                    <item id="language">
                      <rank>50</rank>
                    </item>
                    <item id="status">
                      <rank>60</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>20</rank>
              <items>
                <item id="fieldset:User:profiles">
                  <rank>10</rank>
                  <items>
                    <item id="profile_list">
                      <rank>10</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="allowed_org_list">
              <rank>80</rank>
            </item>
            <item id="log">
              <rank>90</rank>
            </item>
          </items>
        </details>
        <list>
          <items>
            <item id="contactid">
              <rank>10</rank>
            </item>
            <item id="org_id">
              <rank>20</rank>
            </item>
            <item id="email">
              <rank>30</rank>
            </item>
            <item id="status">
              <rank>40</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>
  </classes>
  <menus>
    <menu id="Oauth2Application" xsi:type="OQLMenuNode" _delta="define">
      <rank>120</rank>
      <parent>Integrations</parent>
      <oql><![CDATA[SELECT Oauth2Application]]></oql>
      <do_search>1</do_search>
      <enable_admin_only>0</enable_admin_only>
      <enable_class>Oauth2Application</enable_class>
      <enable_action>UR_ACTION_MODIFY</enable_action>
    </menu>
  </menus>
  <dictionaries>
  </dictionaries>
  <user_rights>
    <groups>
      <group id="PersonalToken" _delta="define">
        <classes>
          <class id="PersonalToken"/>
        </classes>
      </group>
    </groups>
    <profiles/>
  </user_rights>
  <module_parameters>
    <parameters id="authent-token" _delta="define">
      <personal_tokens_allowed_profiles type="array">
        <item>Administrator</item>
      </personal_tokens_allowed_profiles>
      <application_token type="hash">
        <allow_fallback_token>false</allow_fallback_token>
      </application_token>
      <enable_myaccount_menu type="bool">true</enable_myaccount_menu>
    </parameters>
  </module_parameters>

</itop_design>
